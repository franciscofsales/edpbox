# /config/files/integral.yaml

#sensor:

  - platform: template
    sensors:

      u1_power:
        friendly_name: U1 Power
        value_template: >-
            {% set a = states('sensor.u1_nominal_real_power')|int %}
            {% set b = states('sensor.u1_load')|int %}
            {{  (a * b / 100)|int }}
        device_class: power
        unit_of_measurement: "W"

      sun_elevation:
        friendly_name: Sun Elevation
        unit_of_measurement: 'Â°'
        value_template: "{{ state_attr('sun.sun', 'elevation') }}"

      fake_solar_pv1:
        friendly_name: Fake Solar PV1
        value_template: >-
            {% set a = states('sensor.mmc_3e_temp')|float + 5.0 %}
            {% set b = states('sensor.sun_elevation')|float / 10.0 %}
            {% set c = (a * b)|float %}
            {% if b > 0 and a > 5 %}
              {{ c|round(1) }}
            {% endif %}
        device_class: power
        unit_of_measurement: "W"

      fake_grid_export:
        friendly_name: Fake Grid Export
        value_template: >-
            {% set a = states('sensor.fake_solar_pv1')|float %}
            {% set b = (a * 0.8)|float %}
            {% if b > 0 %}
              {{ b|round(1) }}
            {% endif %}
        device_class: power
        unit_of_measurement: "W"

###

  - platform: integration
    source: sensor.eb3_active_power_l1
    name: EM EB3 L1
    unit_prefix: k
    round: 2

  - platform: integration
    source: sensor.eb3_active_power_l2
    name: EM EB3 L2
    unit_prefix: k
    round: 2

  - platform: integration
    source: sensor.eb3_active_power_l3
    name: EM EB3 L3
    unit_prefix: k
    round: 2

  - platform: integration
    source: sensor.u1_power
    name: EM UPS U1
    unit_prefix: k
    round: 2

  - platform: integration
    source: sensor.fake_solar_pv1
    name: EM Fake Solar PV1
    unit_prefix: k
    round: 2

  - platform: integration
    source: sensor.fake_grid_export
    name: EM Fake Grid
    unit_prefix: k
    round: 2

# EOF
