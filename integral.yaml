# /config/files/integral.yaml

#sensor:

  - platform: template
    sensors:

      u1_power:
        friendly_name: U1 Power
        value_template: >-
            {% set a = states('sensor.u1_nominal_real_power')|int %}
            {% set b = states('sensor.u1_load')|int %}
            {{  (a * b / 100)|int }}
        device_class: power
        unit_of_measurement: "W"

      sun_elevation:
        friendly_name: Sun Elevation
        unit_of_measurement: 'Â°'
        value_template: "{{ state_attr('sun.sun', 'elevation') }}"

      fake_solar_w:
        friendly_name: Fake Solar W
        value_template: >-
            {% set a = ( states('sensor.sun_elevation')|float * 5 * 8 ) | float %}
            {% if a > 0 %}
              {{ a|round(2) }}
            {% endif %}
        device_class: power
        unit_of_measurement: "W"

      fake_export_w:
        friendly_name: Fake Export W
        value_template: >-
            {% set a = states('sensor.fake_solar_w')|float %}
            {% set b = (a * 0.199)|float %}
            {% if b > 0 %}
              {{ b|round(2) }}
            {% endif %}
        device_class: power
        unit_of_measurement: "W"

      fake_batt_in_w:
        friendly_name: Fake Batt In W
        value_template: >-
            {% set a = states('sensor.fake_solar_w')|float %}
            {% set b = (a * 0.599)|float %}
            {% if b > 0 %}
              {{ b|round(2) }}
            {% endif %}
        device_class: power
        unit_of_measurement: "W"

      fake_batt_out_w:
        friendly_name: Fake Batt Out W
        value_template: >-
            {% set a = states('sensor.sun_elevation')|float %}
            {% if a < 0 %}
              {{ states('sensor.eb3_active_power')|float }}
            {% endif %}
        device_class: power
        unit_of_measurement: "W"

###

  - platform: integration
    source: sensor.eb3_active_power_l1
    name: EM3 L1
    unit_prefix: k
    round: 2

  - platform: integration
    source: sensor.eb3_active_power_l2
    name: EM3 L2
    unit_prefix: k
    round: 2

  - platform: integration
    source: sensor.eb3_active_power_l3
    name: EM3 L3
    unit_prefix: k
    round: 2

  - platform: integration
    source: sensor.u1_power
    name: EM UPS1
    unit_prefix: k
    round: 2

  - platform: integration
    source: sensor.fake_solar_w
    name: Fake Solar
    unit_prefix: k
    round: 2

  - platform: integration
    source: sensor.fake_export_w
    name: Fake Export
    unit_prefix: k
    round: 2

  - platform: integration
    source: sensor.fake_batt_in_w
    name: Fake Batt In
    unit_prefix: k
    round: 2

  - platform: integration
    source: sensor.fake_batt_out_w
    name: Fake Batt Out
    unit_prefix: k
    round: 2

# EOF
