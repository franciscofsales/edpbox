# tasmota-eb3.yaml
# edpbox3

  - platform: mqtt
    name: "EB3 ESP Uptime"
    unique_id: EB3_ESP_Uptime
    state_topic: "tele/edpbox3/STATE"
    value_template: '{{ ( value_json.UptimeSec / 3600 ) | round(1) }}'
    unit_of_measurement: "h"
    icon: mdi:alarm

  - platform: mqtt
    name: "EB3 ESP Free Heap"
    unique_id: EB3_ESP_Heap
    state_topic: "tele/edpbox3/STATE"
    value_template: '{{ value_json.Heap }}'
    unit_of_measurement: "kB"
    icon: mdi:chip

  - platform: mqtt
    name: "EB3 ESP Signal"
    unique_id: EB3_ESP_Signal
    state_topic: "tele/edpbox3/STATE"
    value_template: '{{ value_json.Wifi.Signal }}'
    unit_of_measurement: "dB"
    device_class: signal_strength

  - platform: mqtt
    name: "EB3 Clock"
    unique_id: EB3_Clock
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set hh = value_json.EB3.Clock_H|int %}
        {% set mm = value_json.EB3.Clock_M|int %}
        {% set ss = value_json.EB3.Clock_S|int %}
        {{ '{0:02d}'.format(hh) + ":" + '{0:02d}'.format(mm) + ":" + '{0:02d}'.format(ss) }}
    icon: mdi:clock

  - platform: mqtt
    name: "EB3 Voltage L1"
    unique_id: EB3_VolL1
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.VolL1|float %}
        {% if x > 0 %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "V"
    device_class: voltage

  - platform: mqtt
    name: "EB3 Voltage L1-10"
    unique_id: EB3_VolL1_10
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.VolL1 | float %}
        {% if x > 0 %}
          {{ x - 10 }}
        {% endif %}
    unit_of_measurement: "V"
    device_class: voltage

  - platform: mqtt
    name: "EB3 Voltage L2"
    unique_id: EB3_VolL2
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.VolL2|float %}
        {% if x > 0 %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "V"
    device_class: voltage

  - platform: mqtt
    name: "EB3 Voltage L3"
    unique_id: EB3_VolL3
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.VolL3|float %}
        {% if x > 0 %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "V"
    device_class: voltage

  - platform: mqtt
    name: "EB3 Voltage L3+10"
    unique_id: EB3_VolL3_10
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.VolL3 | float %}
        {% if x > 0 %}
          {{ x + 10 }}
        {% endif %}
    unit_of_measurement: "V"
    device_class: voltage

  - platform: mqtt
    name: "EB3 Current"
    unique_id: EB3_Current
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.Current|float %}
        {% if x %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "A"
    device_class: current

  - platform: mqtt
    name: "EB3 Current L1"
    unique_id: EB3_CurL1
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.CurL1|float %}
        {% if x %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "A"
    device_class: current

  - platform: mqtt
    name: "EB3 Current L2"
    unique_id: EB3_CurL2
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.CurL2|float %}
        {% if x %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "A"
    device_class: current

  - platform: mqtt
    name: "EB3 Current L3"
    unique_id: EB3_CurL3
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.CurL3|float %}
        {% if x %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "A"
    device_class: current

  - platform: mqtt
    name: "EB3 Power Factor"
    unique_id: EB3_PowFac
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.PowFac|float %}
        {% if x > 0 %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "pu"
    device_class: power_factor

  - platform: mqtt
    name: "EB3 Power Factor L1"
    unique_id: EB3_PowFacL1
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.PowFacL1|float %}
        {% if x > 0 %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "pu"
    device_class: power_factor

  - platform: mqtt
    name: "EB3 Power Factor L2"
    unique_id: EB3_LowFacL2
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.PowFacL2|float %}
        {% if x > 0 %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "pu"
    device_class: power_factor

  - platform: mqtt
    name: "EB3 Power Factor L3"
    unique_id: EB3_PowFacL3
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.PowFacL3|float %}
        {% if x > 0 %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "pu"
    device_class: power_factor

  - platform: mqtt
    name: "EB3 Active Power"
    unique_id: EB3_ActPow
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.ActPow|int %}
        {% if x %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "W"
    device_class: power

  - platform: mqtt
    name: "EB3 Active Power L1"
    unique_id: EB3_ActLowL1
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.ActPowL1|int %}
        {% if x %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "W"
    device_class: power

  - platform: mqtt
    name: "EB3 Active Power L2"
    unique_id: EB3_ActPowL2
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.ActPowL2|int %}
        {% if x %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "W"
    device_class: power

  - platform: mqtt
    name: "EB3 Active Power L3"
    unique_id: EB3_ActLowL3
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.ActPowL3|int %}
        {% if x %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "W"
    device_class: power

  - platform: mqtt
    name: "EB3 Frequency"
    unique_id: EB3_Frequency
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.Frequency|float %}
        {% if x > 0 %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "Hz"
    icon: mdi:pulse

  - platform: mqtt
    name: "EB3 Total Energy T1 Vazio"
    unique_id: EB3_TotEneT1
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.TotEneT1|float %}
        {% if x > 0 %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "kWh"
    icon: mdi:transmission-tower
   
  - platform: mqtt
    name: "EB3 Total Energy T2 Ponta"
    unique_id: EB3_TotEneT2
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.TotEneT2|float %}
        {% if x > 0 %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "kWh"
    icon: mdi:transmission-tower
    
  - platform: mqtt
    name: "EB3 Total Energy T3 Cheias"
    unique_id: EB3_TotEneT3
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.TotEneT3|float %}
        {% if x > 0 %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "kWh"
    icon: mdi:transmission-tower

  - platform: mqtt
    name: "EB3 Total Energy Import"
    unique_id: EB3_TotEneImp
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.TotEneImp|float %}
        {% if x > 0 %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "kWh"
    device_class: energy

  - platform: mqtt
    name: "EB3 Total Energy Export"
    unique_id: EB3_TotEneExp
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.TotEneExp|float %}
        {% if x > 0 %}
          {{ x }}
        {% endif %}
    unit_of_measurement: "kWh"
    device_class: energy

  - platform: mqtt
    name: "EB3 Tariff"
    unique_id: EB3_Tariff
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.Tariff|int %}
        {% if x == 1 %}
          {{ "Vazio" }}
        {% elif x == 2 %}
          {{ "Ponta" }}
        {% elif x == 3 %}
          {{ "Cheias" }}
        {% endif %}
    icon: mdi:calendar

  - platform: mqtt
    name: "EB3 Fw4"
    unique_id: EB3_Fw4
    state_topic: "tele/edpbox3/SENSOR"
    value_template: >-
        {% set x = value_json.EB3.Fw41|int|string %}
        {% set y = value_json.EB3.Fw42|int|string %}
        {% set x = format(x,"04X") %}
        {% set y = format(y,"04X") %}
        {{ "V" + x + ":" + y }}
    icon: mdi:calendar

###
##
#
